<!DOCTYPE html>
<html>

<head>
    <title>BLE</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script>
        // Helper function to calculate time ago
        function timeAgo(dateTime) {
            const now = new Date();
            const diff = now - new Date(dateTime);
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) {
                return days + " day" + (days > 1 ? "s" : "") + " ago";
            } else if (hours > 0) {
                return hours + " hour" + (hours > 1 ? "s" : "") + " ago";
            } else if (minutes > 0) {
                return minutes + " minute" + (minutes > 1 ? "s" : "") + " ago";
            } else {
                return seconds + " second" + (seconds > 1 ? "s" : "") + " ago";
            }
        }

        function getDiagnosticId(diagnosticId) {
            if (diagnosticId) {
                if (diagnosticId === "a3WBKyxpR9E-tXHOy0cRXjw") {
                    return "RSSI";
                } else if (diagnosticId === "aq2dIrRFGfkW3g98ILX98SQ") {
                    return "Temperature";
                } else if (diagnosticId === "DiagnosticDeviceBatteryVoltageId") {
                    return "Battery ";
                }
            }
            return "Unknown Diagnostic";
        }

        geotab.addin.integrationExample = function (api, state) {
            var center = document.getElementById("center"),
                listCreator = function (entities) {
                    var table = document.createElement("table");
                    var headerRow = document.createElement("tr");
                    headerRow.innerHTML = "<th>Id</th><th>Date</th><th>Diagnostic</th><th>Value</th>";
                    table.appendChild(headerRow);

                    entities.forEach(function (entity) {
                        var row = document.createElement("tr");
                        var idCell = document.createElement("td");
                        idCell.textContent = entity.id;
                        var timeCell = document.createElement("td");
                        timeCell.innerHTML = "<span class='time-ago'>" + timeAgo(entity.dateTime) + "</span>";
                        var diagnosticCell = document.createElement("td");
                        diagnosticCell.textContent = getDiagnosticId(entity.diagnostic.id);
                        var valueCell = document.createElement("td");
                        valueCell.textContent = entity.data;
                        row.appendChild(idCell);
                        row.appendChild(timeCell);
                        row.appendChild(diagnosticCell);
                        row.appendChild(valueCell);
                        table.appendChild(row);
                    });

                    return table;
                },
                refreshPage = function () {
                    api.call("Get", {
                        "typeName": "StatusData",
                        "sort": {
                            "sortBy": "date",
                            "sortDirection": "desc",
                        },
                        "resultsLimit": 1000,
                    }, function (result) {
                        console.log("result : ", result);
                        var list = listCreator(result);
                        center.innerHTML = "";
                        center.appendChild(list);
                    }, function (error) {
                        console.log(error.message);
                    });
                },
                clearOnLeaving = function () {
                    center.innerHTML = "";
                };

            return {
                initialize: function (api, state, callback) {
                    callback();
                },
                focus: function (api, state) {
                    refreshPage();
                },
                blur: function (api, state) {
                    clearOnLeaving();
                }
            };
        };
    </script>
</head>

<body>
    <div id="center" class="TNT_main"></div>
</body>

</html>